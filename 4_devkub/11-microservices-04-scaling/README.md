## Домашнее задание к занятию "11.04 Микросервисы: масштабирование"

Вы работаете в крупной компанию, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps специалисту необходимо выдвинуть предложение по организации инфраструктуры, для разработки и эксплуатации.

### Задача 1: Кластеризация

Предложите решение для обеспечения развертывания, запуска и управления приложениями.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- Поддержка контейнеров;
- Обеспечивать обнаружение сервисов и маршрутизацию запросов;
- Обеспечивать возможность горизонтального масштабирования;
- Обеспечивать возможность автоматического масштабирования;
- Обеспечивать явное разделение ресурсов доступных извне и внутри системы;
- Обеспечивать возможность конфигурировать приложения с помощью переменных среды, в том числе с возможностью безопасного хранения чувствительных данных таких как пароли, ключи доступа, ключи шифрования и т.п.

Обоснуйте свой выбор.

### Ответ:
Руководствовался этими статьями:  
https://mcs.mail.ru/blog/sravnenie-kubernetes-s-drugimi-resheniyami  
https://habr.com/ru/company/kts/blog/591355/  
https://wiki.merionet.ru/servernye-resheniya/66/14-instrumentov-orkestracii-kontejnerov-dlya-devops/  
  
1. Kubernetes().
    + (**+**)Поддержка контейнеров(Docker, containerd, CRI-O);
    + (**+**)Обеспечивать обнаружение сервисов и маршрутизацию запросов(через внутренний DNS кластера, или с помощью переменных окружения);
    + (**+**)Обеспечивать возможность горизонтального масштабирования;
    + (**+**)Обеспечивать возможность автоматического масштабирования;
    + (**+**)Обеспечивать явное разделение ресурсов доступных извне и внутри системы;
    + (**+**)Обеспечивать возможность конфигурировать приложения с помощью переменных среды, в том числе с возможностью безопасного хранения чувствительных данных таких как пароли, ключи доступа, ключи шифрования и т.п.

2. Docker Swarm.
    + (**+**)Поддержка контейнеров(только Docker контейнеры);
    + (**+**)Обеспечивать обнаружение сервисов и маршрутизацию запросов(через встроенный DNS, или внешний балансировщик);
    + (**+**)Обеспечивать возможность горизонтального масштабирования;
    - (**—**)Обеспечивать возможность автоматического масштабирования(Количество экземпляров необходимо указать вручную в параметре replicas);
    - (**—**)Обеспечивать явное разделение ресурсов доступных извне и внутри системы;
    + (**+**)Обеспечивать возможность конфигурировать приложения с помощью переменных среды, в том числе с возможностью безопасного хранения чувствительных данных таких как пароли, ключи доступа, ключи шифрования и т.п.
По отзывам Docker Swarm быстрее, и проще в управлении чем Kubernetes, но возможностей у него меньше.

3. Nomad.
    + (**+**)Поддержка контейнеров(Docker, и многое другое: вирт. машины, бинарники Java);
    + (**+**)Обеспечивать обнаружение сервисов и маршрутизацию запросов(через Consul);
    + (**+**)Обеспечивать возможность горизонтального масштабирования;
    + (**+**)Обеспечивать возможность автоматического масштабирования(через Nomad Autoscaler);
    + (**+**)Обеспечивать явное разделение ресурсов доступных извне и внутри системы;
    + (**+**)Обеспечивать возможность конфигурировать приложения с помощью переменных среды, в том числе с возможностью безопасного хранения чувствительных данных таких как пароли, ключи доступа, ключи шифрования и т.п.(Vault)

4. Apach Mesos(+ Maraphon, Aurora).
    + (**+**)Поддержка контейнеров(Docker and AppC);
    + (**+**)Обеспечивать обнаружение сервисов и маршрутизацию запросов(Mesos-DNS, Marathon-LB, Mesos DiscoveryInfo);
    + (**+**)Обеспечивать возможность горизонтального масштабирования(вертикальное тоже возможно);
    + (**+**)Обеспечивать возможность автоматического масштабирования;
    + (**+**)Обеспечивать явное разделение ресурсов доступных извне и внутри системы;
    + (**+**)Обеспечивать возможность конфигурировать приложения с помощью переменных среды, в том числе с возможностью безопасного хранения чувствительных данных таких как пароли, ключи доступа, ключи шифрования и т.п.
Сложнее в администрировании, проще в развертывании, производительнее K8s.  

Наверное выбрал бы K8s из-за его распространенности, хорошей документации.  
Но и Nomad интересная штука.  

-----

### Задача 2: Распределенный кэш * (необязательная)

Разработчикам вашей компании понадобился распределенный кэш для организации хранения временной информации по сессиям пользователей.
Вам необходимо построить Redis Cluster состоящий из трех шард с тремя репликами.

### Схема:

![11-04-01](https://user-images.githubusercontent.com/1122523/114282923-9b16f900-9a4f-11eb-80aa-61ed09725760.png)  
### Ответ:  
При выполнении работы использовал эту статью:  
https://netpoint-dc.com/blog/redis-cluster-linux/  
и множество других, но в основном по этой статье.  
Прилагаю файлы для развертывания стенда terraform-ом и роль ansible для установки сервисов.  
Для установку ruby используется роль: https://github.com/rvm/rvm1-ansible  
Она немного старовата и иногда некоректно срабатывает, в процессе работы ругается на старые ключи(некритично).  
Если что, её можно заменить на: https://github.com/geerlingguy/ansible-role-ruby  
Процесс:
```
terraform init  
terraform plan  
terraform apply var="token=тут ваш токен"  
```
Если нужно сменить пользователя, то меняем в metadata.txt(логин и паблик кей) и в inventory.tmpl(логин).  
Далее ansible:  
```
ansible-playbook site.yml -i hosts.yml
```
Playbook установит по 2 redis-а на каждую виртуалку и сформирует кластер(по 1 узлу на каждом хосте).  
Слейвы придется добавить вручную, т.к. для их добавления нужен master_id, который выдается после формирования кластера.  
Для добавления слева используем команду:  
```
redis-cli --cluster add-node тут_слейв_ip:слейв_порт тут_мастер_ip:мастер_порт --cluster-slave --cluster-master-id тут_мастер_id
```
Лог добавления слейвов:  
Что есть после выполнения плейбука:
```
[andrey@fhm3v1vch58ricr04vjh ~]$ redis-cli
127.0.0.1:6379> CLUSTER NODES
b24ca2199353243a8372f3f5a0124e49079d5baf 62.84.117.86:6381@16381 master - 0 1639741497269 3 connected 10923-16383
29dede787f4cf39b7604f87209e1cb353b906fe8 10.130.0.3:6379@16379 myself,master - 0 1639741497000 1 connected 0-5460
7b7c8cbf2da511cde082433a8015e3d28ab6b6e3 62.84.115.165:6380@16380 master - 0 1639741498273 2 connected 5461-10922
127.0.0.1:6379> exit
```
Добавляем слейвы:
```
[andrey@fhm3v1vch58ricr04vjh ~]$ redis-cli --cluster add-node 62.84.117.86:6380 62.84.115.165:6380 --cluster-slave --cluster-master-id 7b7c8cbf2da511cde082433a8015e3d28ab6b6e3
>>> Adding node 62.84.117.86:6380 to cluster 62.84.115.165:6380
>>> Performing Cluster Check (using node 62.84.115.165:6380)
M: 7b7c8cbf2da511cde082433a8015e3d28ab6b6e3 62.84.115.165:6380
   slots:[5461-10922] (5462 slots) master
M: b24ca2199353243a8372f3f5a0124e49079d5baf 62.84.117.86:6381
   slots:[10923-16383] (5461 slots) master
M: 29dede787f4cf39b7604f87209e1cb353b906fe8 62.84.118.232:6379
   slots:[0-5460] (5461 slots) master
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
>>> Send CLUSTER MEET to node 62.84.117.86:6380 to make it join the cluster.
Waiting for the cluster to join
>>> Configure node as replica of 62.84.115.165:6380.
[OK] New node added correctly.

[andrey@fhmu5h9kjh8334k1n4ur ~]$ redis-cli --cluster add-node 62.84.118.232:6381 62.84.117.86:6381 --cluster-slave --cluster-master-id b24ca2199353243a8372f3f5a0124e49079d5baf
>>> Adding node 62.84.118.232:6381 to cluster 62.84.117.86:6381
>>> Performing Cluster Check (using node 62.84.117.86:6381)
M: b24ca2199353243a8372f3f5a0124e49079d5baf 62.84.117.86:6381
   slots:[10923-16383] (5461 slots) master
M: 29dede787f4cf39b7604f87209e1cb353b906fe8 62.84.118.232:6379
   slots:[0-5460] (5461 slots) master
M: 7b7c8cbf2da511cde082433a8015e3d28ab6b6e3 62.84.115.165:6380
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
S: 917a5af9d99b48f57d3a10ad75fec0bead6e3c85 62.84.117.86:6380
   slots: (0 slots) slave
   replicates 7b7c8cbf2da511cde082433a8015e3d28ab6b6e3
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
>>> Send CLUSTER MEET to node 62.84.118.232:6381 to make it join the cluster.
Waiting for the cluster to join
>>> Configure node as replica of 62.84.117.86:6381.
[OK] New node added correctly.

[andrey@fhm3ps69b44g0t8p99k7 ~]$ redis-cli --cluster add-node 62.84.115.165:6379 62.84.118.232:6379 --cluster-slave --cluster-master-id 29dede787f4cf39b7604f87209e1cb353b906fe8
>>> Adding node 62.84.115.165:6379 to cluster 62.84.118.232:6379
>>> Performing Cluster Check (using node 62.84.118.232:6379)
M: 29dede787f4cf39b7604f87209e1cb353b906fe8 62.84.118.232:6379
   slots:[0-5460] (5461 slots) master
M: 7b7c8cbf2da511cde082433a8015e3d28ab6b6e3 62.84.115.165:6380
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
S: 917a5af9d99b48f57d3a10ad75fec0bead6e3c85 62.84.117.86:6380
   slots: (0 slots) slave
   replicates 7b7c8cbf2da511cde082433a8015e3d28ab6b6e3
M: b24ca2199353243a8372f3f5a0124e49079d5baf 62.84.117.86:6381
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
S: 7bfcc47856a3fa864df822833984916674f4350a 62.84.118.232:6381
   slots: (0 slots) slave
   replicates b24ca2199353243a8372f3f5a0124e49079d5baf
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
>>> Send CLUSTER MEET to node 62.84.115.165:6379 to make it join the cluster.
Waiting for the cluster to join
>>> Configure node as replica of 62.84.118.232:6379.
[OK] New node added correctly.
```
Что получилось в итоге:
```
[andrey@fhm3v1vch58ricr04vjh ~]$ redis-cli CLUSTER NODES
7b7c8cbf2da511cde082433a8015e3d28ab6b6e3 62.84.115.165:6380@16380 master - 0 1639742558555 2 connected 5461-10922
917a5af9d99b48f57d3a10ad75fec0bead6e3c85 62.84.117.86:6380@16380 slave 7b7c8cbf2da511cde082433a8015e3d28ab6b6e3 0 1639742559559 2 connected
29dede787f4cf39b7604f87209e1cb353b906fe8 10.130.0.3:6379@16379 myself,master - 0 1639742559000 1 connected 0-5460
b24ca2199353243a8372f3f5a0124e49079d5baf 62.84.117.86:6381@16381 master - 0 1639742559000 3 connected 10923-16383
7bfcc47856a3fa864df822833984916674f4350a 62.84.118.232:6381@16381 slave b24ca2199353243a8372f3f5a0124e49079d5baf 0 1639742560563 3 connected
df79daa12ba6330ca45358354acbe351bd283413 62.84.115.165:6379@16379 slave 29dede787f4cf39b7604f87209e1cb353b906fe8 0 1639742558000 1 connected
[andrey@fhm3v1vch58ricr04vjh ~]$ 
```
